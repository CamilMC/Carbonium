---
title: "Isere Campus"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    number_section: true
date: "2025-06-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, error = F, fig.align = "center", collapse = T,
                      cache = T)
```

```{r libraries}

library(ggplot2)
library(ggpubr)

library(dplyr)
library(readxl)
library(lubridate)

library(bayesbio)
```


# Données

Les données dont on dispose pour la station de mesures d'Isère - campus sont: 

* débits horaires de 2005 à 2025
* CMES de 2006 à 2025
* POC mesuré (et non calculé): 
    - Carbonisère: suivi hebdo de 2006 à 2008 + crue du 19 mai 2006  + chasse du 27/06/2006 + crue du 30/08/2006 + chasse du 5/06/2006
    - crues du 19/08/2022 (lave torrentielle) et chasse du 22/06/2022
    - suivi hebdo Carbonium (pas encore disponible)
* DOC: 
  - Carbonisère: suivi hebdo de 2006 à 2008 + crue du 19 mai 2006  + chasse du 27/06/2006 + crue du 30/08/2006 + chasse du 5/06/2006
  - suivi hebdo Carbonium (pas encore dispo)

## Charger les données

```{r data}

# Crues
carbonisere <- read_xlsx("Bilan carbonisère.xlsx")


crues_2022 <- read_xlsx(path = "Crues_Isère_2022.xlsx", sheet = "test_match") 
crues_2022$mes_mg.L <- NA
crues_2022$debit_m3.s <- NA
crues_2022$doc_mg.L <- NA

doc_isere_2011 <- read_excel("doc_isere_2011-2012.xls")
doc_isere_2011$name <- "DOC 2011"
doc_isere_2011$poc_percent <- NA
doc_isere_2011$mes_mg.L <- doc_isere_2011$mes_g.L * 1e3

poc_isere_2011 <- read_excel("poc_isere_2011-2012.xls")
poc_isere_2011$doc_mg.L <- NA
poc_isere_2011$name <- "POC 2011"
poc_isere_2011$mes_mg.L <- poc_isere_2011$mes_g.L * 1e3

crues <- rbind(select(carbonisere, c("DateHeure","name","debit_m3.s","mes_mg.L","poc_percent", "doc_mg.L")),select(crues_2022, c("DateHeure","name","debit_m3.s", "mes_mg.L","poc_percent", "doc_mg.L"))) %>%
  rbind(select(doc_isere_2011, c("DateHeure","name","debit_m3.s","mes_mg.L","poc_percent", "doc_mg.L"))) %>% rbind(select(poc_isere_2011, c("DateHeure","name","debit_m3.s","mes_mg.L","poc_percent", "doc_mg.L")))

# Chroniques BDOH
cmes <- readxl::read_xlsx(path = "isere.xlsx", sheet = "cmes", col_types = c("date","numeric","text")) %>% subset(Qualite == "v") %>% mutate(Qualite = NULL)
debit <- readxl::read_xlsx(path = "isere.xlsx", sheet = "debit", col_types = c("date","numeric","text")) %>% subset(Qualite == "v") %>% mutate(Qualite = NULL)

  
#crues <- crues %>% group_by(Crue) %>% mutate(period = as.numeric(-(Date - lead(Date)))) # period in hours


isere <- merge(debit, cmes, by="DateHeure") %>% merge(crues, by = "DateHeure", all = T) 
isere$year <- year(isere$DateHeure)
isere$commondate <- as.Date(paste0("2000-", format(isere$Date,"%j")), "%Y-%j")

isere$period <- as.numeric(-(isere$DateHeure - lead(isere$DateHeure))) # period in s

summary_isere <- merge(
isere %>% subset(!is.na(poc_percent)) %>% group_by(year) %>% summarise(nb_poc = n()),
isere %>% subset(!is.na(cmes_g.L)) %>% group_by(year) %>% summarise(nb_cmes = n()),
by = "year", all = T) %>% 
  merge(isere %>% subset(!is.na(doc_mg.L)) %>% group_by(year) %>% summarise(nb_doc = n()), by = "year", all = T) %>%
  merge(isere %>% subset(!is.na(q_m3.s)) %>% group_by(year) %>% summarise(nb_q = n()), by = "year", all = T) %>%
  merge(isere %>% subset(!is.na(period)) %>% group_by(year) %>% summarise(total_period_j = sum(period)/(24*60*60)), by = "year", all = T)
  
summary_isere %>% knitr::kable(caption = "Nombre d'observations de DOC, POC, CMES et débit par an") %>% kableExtra::kable_styling()


```

```{r annual-q-mes, fig.dim = c(10, 10)}

ggarrange(
ggplot(isere, aes(x = commondate)) + 
  geom_point(aes(y = q_m3.s), col = "lightblue", size = 0.5) +
  scale_x_date(labels = function(x) format(x, "%d-%b"), date_minor_breaks = "1 month", name = "")+
  facet_grid(rows = vars(year))+
  labs(x = "", y = "Q, m3/s") +
  theme_minimal()+
  theme(legend.position = "bottom"),

ggplot(isere, aes(x = commondate)) + 
  geom_point(aes(y = cmes_g.L), col = "palegreen4", size = 0.5) +
  scale_x_date(labels = function(x) format(x, "%d-%b"), date_minor_breaks = "1 month", name = "")+
  facet_grid(rows = vars(year))+
  labs(x = "", y = "CMES, g/L") +
  theme_minimal()+
  theme(legend.position = "bottom"),

ncol = 2
) %>%
  annotate_figure(top = text_grob("Mesures de débit et CMES", face = "bold", size = 14))

```

```{r annual-doc-poc, fig.dim = c(10, 5)}

ggarrange(

ggplot(subset(isere, !is.na(doc_mg.L)), aes(x = commondate)) + 
  geom_point(aes(y = doc_mg.L), col = "orange") +
  scale_x_date(labels = function(x) format(x, "%d-%b"), date_minor_breaks = "1 month", name = "")+
  facet_grid(rows = vars(year))+
  labs(x = "", y = "DOC, mg/L") +
  theme_minimal()+
  theme(legend.position = "bottom"),

ggplot(subset(isere, !is.na(poc_percent)), aes(x = commondate)) + 
  geom_point(aes(y = poc_percent), col = "darkred") +
  scale_x_date(labels = function(x) format(x, "%d-%b"), date_minor_breaks = "1 month", name = "")+
  facet_grid(rows = vars(year))+
  labs(x = "", y = "POC, %") +
  theme_minimal()+
  theme(legend.position = "bottom"),

ncol = 2
) %>%
  annotate_figure(top = text_grob("Mesures de DOC et POC", face = "bold", size = 14))



```

Les mesures de POC sont réalisées parallèlement à des mesures de MES. La valeur de *MES* mesurée à cette occasion est légèrement différente de la valeur de *CMES* reconstruire à partir des sondes de turbidité. 

```{r compare-cmes-and-mes}
ggplot(isere)+
  geom_point(aes(x=cmes_g.L, y = mes_mg.L, col = name))+
  geom_abline(slope = 1000, intercept = 0)+
  scale_colour_viridis_d()+
  labs(title = "Comparaison entre CMES et MES", x = "CMES, g/L", y = "MES, mg/L")+
  scale_x_continuous(limits = c(0,20))+ 
  theme_minimal()

ggarrange(
  ggplot(isere)+
    geom_point(aes(x = mes_mg.L, y = poc_percent, col = name))+
    scale_color_viridis_d()+
    scale_x_continuous(trans = "log")+scale_y_continuous(trans = "log")+
    labs( x = "MES, mg/L", y = "POC%")+
    theme_minimal(),
  ggplot(isere)+
    geom_point(aes(x = cmes_g.L, y = poc_percent, col = name))+
        scale_color_viridis_d()+
      scale_x_continuous(trans = "log")+scale_y_continuous(trans = "log")+
        labs( x = "CMES, g/L", y = "POC%")+
    theme_minimal(),
  ncol = 2, common.legend = T, legend = "bottom"
) %>%
  annotate_figure(top = text_grob("POC% et valeur associée de MES et CMES", face = "bold", size = 14))


```


## Example of data - Carbonisere

Visualisation des données de la campagne Carbonisère: DOC et POC mesurés sur les années 2006-2007-2009. 

```{r view-fluxes}

ggplot(carbonisere)+
  geom_point(aes(x=as.Date(DateHeure), y = debit_m3.s), col = "cadetblue4")+
  geom_abline(slope = 0, intercept = mean(carbonisere$debit_m3.s, na.rm = T), col = "darkred")+
 annotate(geom = "label", label = round(mean(carbonisere$debit_m3.s, na.rm = T), 2), x= as.Date("2008-01-01"), y = 250)+
   scale_x_date(labels = function(x) format(x, "%d-%b-%y"), date_breaks = "1 year", date_minor_breaks = "1 month",name = "", limits = c(as.Date("2006-01-01"), as.Date("2008-03-31")))+ 
  labs(y = "Débit, m3/s")+
  theme_minimal(base_size = 15)

isere678 <- subset(isere, year == c(2006,2007,2008))

ggplot(isere678)+
  geom_point(aes(x=as.Date(DateHeure), y = q_m3.s), col = "cadetblue4", size = 1)+
  geom_abline(slope = 0, intercept = mean(isere678$q_m3.s, na.rm = T), col = "darkred")+
 annotate(geom = "label", label = round(mean(isere678$q_m3.s, na.rm = T), 2), x= as.Date("2006-01-01"), y = 200)+
   scale_x_date(labels = function(x) format(x, "%d-%b-%y"), date_breaks = "1 year", date_minor_breaks = "1 month",name = "", limits = c(as.Date("2006-01-01"), as.Date("2008-03-31")))+ 
  labs(y = "Débit, m3/s")+
  theme_minimal(base_size = 15)

ggplot(carbonisere)+
  geom_point(aes(x=as.Date(DateHeure), y = doc_mg.L), col = "darkolivegreen4")+
  geom_abline(slope = 0, intercept = mean(carbonisere$doc_mg.L, na.rm = T), col = "darkred")+
 annotate(geom = "label", label = round(mean(carbonisere$doc_mg.L, na.rm = T), 2), x= as.Date("2008-01-01"), y = 3)+
   scale_x_date(labels = function(x) format(x, "%d-%b-%y"), date_breaks = "1 year", date_minor_breaks = "1 month",name = "", limits = c(as.Date("2006-01-01"), as.Date("2008-03-31")))+ 
  labs(y = "Carbone Organique Dissous, mg/L")+
  theme_minimal(base_size = 15)


ggplot(carbonisere)+
  geom_point(aes(x=as.Date(DateHeure), y = poc_percent*mes_mg.L), col = "darkolivegreen4")+
 #  geom_abline(slope = 0, intercept = mean(carbonisere$poc_percent * carbonisere$mes_mg.L, na.rm = T), col = "darkred")+
 # annotate(geom = "label", label = round(mean(carbonisere$poc_percent * carbonisere$mes_mg.L, na.rm = T), 2), x= as.Date("2008-01-01"), y = 3)+
   scale_x_date(labels = function(x) format(x, "%d-%b-%y"), date_breaks = "1 year", date_minor_breaks = "1 month",name = "", limits = c(as.Date("2006-01-01"), as.Date("2008-03-31")))+ 
  labs(y = "Carbone Organique Particulaire, mg/L")+
  theme_minimal(base_size = 15)

```




# Method - which relation MES-POC to choose?

Objectif: construire la relation MES-POC pour pouvoir reconstruire la chronique de POC à partir de la chronique de MES. Cette relation prend la forme de $POC% = a*MES^b + c$.


## Fit MES-POC, all events

Modèle de référence. Toutes données disponibles sont utilisées pour fitter la relation MES POC. 

La valeur de l'asymptote (c) est calculée en utilisant le POC% médian correspondants aux 10% des valeurs les plus élevées de MES. Le fit est réalisé sur MES (valeurs mesurées en parallèle du POC).

```{r fit-poc-mes-forcing-end-value}
poc_isere <- isere %>% subset(!is.na(poc_percent))

# find asymptotic value
tail_value <- poc_isere[order(poc_isere$cmes_g.L, decreasing = T),] %>% pull(poc_percent) %>% head(dim(poc_isere)[1]/10) %>% median() # 10% of poc_percent corresponding to the max cmes

# add mes for POC 2011
poc_isere$mes_for_fit <- poc_isere$mes_mg.L
poc_isere$mes_for_fit[which(is.na(poc_isere$mes_for_fit))] <- poc_isere$cmes_g.L[which(is.na(poc_isere$mes_for_fit))]*1e3
poc_isere$tail <- tail_value

pocfit <- nls(
  poc_percent ~ a * mes_for_fit^b + tail,
  data = poc_isere,
  start = list(a = 1, b = -0.5)
)

summary(pocfit)
poc_isere$poc_nls_fitted <- predict(pocfit, poc_isere)

formula_pocfit <- paste("NLS : POC =", round(coef(pocfit)[1],2), "* MES (mg/L) ^", round(coef(pocfit)[2],2), "+", round(tail_value,2))

ggplot(poc_isere)+
  geom_point(aes(x=mes_for_fit, y = poc_percent, col = "measured"))+ 
  geom_point(aes(x=mes_for_fit, y = poc_nls_fitted, col = "fitted"))+ 
  geom_abline(slope = 0, intercept = tail_value, col = "darkred")+
  annotate(geom = "label", label = formula_pocfit, x = Inf, y = Inf, hjust = 1.1, vjust = 1.1)+
  scale_color_manual(values = c("darkblue", "lightblue"))+
  labs(x = "MES, mg/L", y = "POC, %")+
  theme_minimal()

plot(resid(pocfit)~fitted(pocfit))

```

## Should we fit with distinct events ?

Que se passe-t-il si on n'effectue pas le fit avec tous les évènements mesurés ?

### Fit par série

Quelle est la différente de fit si on effectue le fit MES-POC sur chacun des évènements analysées (crue, chasse, suivi)?

```{r fit-by-event, eval = T}
name_crues <- subset(poc_isere, !is.na(name) & name != "DOC 2011") %>% pull(name) %>% unique()

for(i in name_crues){
  df <- poc_isere
  dfi <- subset(df, name == i &!is.na(poc_percent))
  
  dfi$tail <- dfi[order(dfi$mes_mg.L, decreasing = T),] %>% pull(poc_percent) %>% head(dim(dfi)[1]/10) %>% median() # 10% of poc_percent corresponding to the max cmes
  
  a_i <- dfi$poc_percent %>% max()
  b_i <- - dfi$tail[1]/2
    
  fiti <-  tryCatch(
    nls(poc_percent ~ a * mes_for_fit^b + tail, data = dfi, start = list(a = a_i, b = b_i)),
    error = function(e) {lm(poc_percent ~ mes_for_fit, data = dfi)}
  )
  
  if(class(fiti)=="nls"){
    coef1 <- coef(fiti)[1]
    coef2 <- coef(fiti)[2]
    formula_fiti <- paste("NLS : POC =", round(coef1,2), "* MES (mg/L) ^", round(coef2,2), "+", round(dfi$tail[1],2))
  } else {
    coef1 <- coef(fiti)[1]
    coef2 <- coef(fiti)[2]
    formula_fiti <- paste("LM : POC =", format(coef2, scientific = T, digits = 2), "* MES (mg/L) +", round(coef1))
 }

  df$poc_percent_fiti <- predict(fiti, newdata = df)
  
 g <- ggplot(subset(df, name ==i), aes(x = mes_for_fit))+
  geom_point(aes(y = poc_percent, col = "measured"))+
  geom_point(aes(y = poc_percent_fiti, col = "fitted only with this event"))+
  geom_point(aes(y = poc_nls_fitted, col = "fitted with all events"))+
  labs(title = i, x = "MES, mg.L", y = "POC, %", col = "")+
  scale_color_manual(values = c("darkblue","hotpink4","lightblue"))+
  geom_abline(slope = 0, intercept = dfi$tail[1], col = "darkred")+
  annotate(geom = "label", label = formula_fiti, x = Inf, y = Inf, hjust = 1.1, vjust = 1.1)+
  theme_minimal()+
  theme(legend.position = "bottom")
  
 print(g)
}

```

### All but one fit

```{r leave-one-out-event-to-fit-the-last, eval = T}
name_crues <- subset(poc_isere, !is.na(name) & name != "DOC 2011") %>% pull(name) %>% unique()

for(i in name_crues){
  df <- poc_isere
  dfi <- subset(df, name != i &!is.na(poc_percent))
  
  dfi$tail <- dfi[order(dfi$mes_mg.L, decreasing = T),] %>% pull(poc_percent) %>% head(dim(dfi)[1]/10) %>% median() # 10% of poc_percent corresponding to the max cmes
  
  a_i <- dfi$poc_percent %>% max()
  b_i <- - dfi$tail[1]/2
    
  fiti <-  tryCatch(
    nls(poc_percent ~ a * mes_for_fit^b + tail, data = dfi, start = list(a = a_i, b = b_i)),
    error = function(e) {lm(poc_percent ~ mes_mg.L, data = dfi)}
  )
  
  if(class(fiti)=="nls"){
    coef1 <- coef(fiti)[1]
    coef2 <- coef(fiti)[2]
    formula_fiti <- paste("NLS : POC =", round(coef1,2), "* MES (mg/L) ^", round(coef2,2), "+", round(dfi$tail[1],2))
  } else {
    coef1 <- coef(fiti)[1]
    coef2 <- coef(fiti)[2]
    formula_fiti <- paste("LM : POC =", format(coef2, scientific = T, digits = 2), "* MES (mg/L) +", round(coef1))
 }

  df$poc_percent_fiti <- predict(fiti, newdata = df)
  
 g <- ggplot(subset(df, name == i), aes(x = mes_for_fit))+
  geom_point(aes(y = poc_percent, col = "measured"))+
  geom_point(aes(y = poc_percent_fiti, col = "fitted with all events except this one"))+
  geom_point(aes(y = poc_nls_fitted, col = "fitted with all events"))+
  labs(title = i, x = "MES, mg.L", y = "POC, %", col = "")+
  scale_color_manual(values = c("darkblue","hotpink4","lightblue"))+
  geom_abline(slope = 0, intercept = dfi$tail[1], col = "darkred")+
  annotate(geom = "label", label = formula_fiti, x = Inf, y = Inf, hjust = 1.1, vjust = 1.1)+
  theme_minimal()+
  theme(legend.position = "bottom")
  
 print(g)
}
```
Conclusion: 

## Extension of POC values to all dataset

```{r all-poc}
isere$mes_for_fit <- isere$cmes_g.L * 1e3 
isere$mes_for_fit <- ifelse(isere$mes_for_fit ==0, NA, isere$mes_for_fit)
isere$poc_fitted <- predict(pocfit, newdata = isere) 

ggplot(isere, aes(x = mes_for_fit))+
  geom_point(aes(y = poc_percent, col = "measured"))+
  geom_point(aes(y = poc_fitted, col = "fitted with all events"))+
  labs(x = "MES, mg.L", y = "POC, %", col = "")+
  scale_color_manual(values = c("darkblue","lightblue"))+
  geom_abline(slope = 0, intercept = tail_value, col = "darkred")+
  annotate(geom = "label", label = formula_pocfit, x = Inf, y = Inf, hjust = 1.1, vjust = 1.1)+
  theme_minimal()+
  theme(legend.position = "bottom")

```


## Quick check: annual flux for POC fitted from asymptot vs annual flux for POC fitted with powerlaw

Calculer annual flux with POC fitted with nls and POC calculated from straight line.

```{r yearly-flux-poc-fitted-asymptot, eval = T}
isere$fpoc_kg.s1 <- with(isere, q_m3.s * 1e3 * (mes_for_fit * tail_value * 1e-2) * 1e-6) # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s

yearly_fluxes_fitted1 <- isere %>% 
                  group_by(year) %>% 
                    summarise(fpoc_kg.year = sum(fpoc_kg.s1 * period, na.rm = T),
                              mean_annual_q = mean(q_m3.s, na.rm = T))

mean_interannual_fpoc <- mean(yearly_fluxes_fitted1$fpoc_kg.year, na.rm = T)

n <- 30

ggplot(yearly_fluxes_fitted1, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570), fill = "palegreen4")+
  geom_line(aes(y = mean_annual_q*n))+
  geom_abline(slope = 0, intercept = mean_interannual_fpoc/5570, col = "darkred")+
  scale_y_continuous(
    name = "Flux de POC, kg/year/km2",
    sec.axis = sec_axis(~./n, name = "Débit moyen annuel, m3/s"))+
  labs(title = "FPOC, from tail value",
       x = paste("Mean interannual flux =", round(mean_interannual_fpoc/5570,0)), 
       y = "Flux de POC, kg/year/km2")+
  theme_minimal()


```
```{r yearly-flux-poc-fitted, eval = T}
isere$fpoc_kg.s2 <- with(isere, q_m3.s * 1e3 * (mes_for_fit * poc_fitted * 1e-2) * 1e-6) # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s

yearly_fluxes_fitted2 <- isere %>% 
                  group_by(year) %>% 
                    summarise(fpoc_kg.year = sum(fpoc_kg.s2 * period, na.rm = T),
                              mean_annual_q = mean(q_m3.s, na.rm = T),
                              nb_datapoints = sum(!is.na(poc_fitted))
                              )

mean_interannual_fpoc <- mean(yearly_fluxes_fitted2$fpoc_kg.year, na.rm = T)

n <- 30

ggplot(yearly_fluxes_fitted2, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570), fill = "palegreen4")+
  geom_line(aes(y = mean_annual_q*n))+
    geom_abline(slope = 0, intercept = mean_interannual_fpoc/5570, col = "darkred")+
  scale_y_continuous(
    name = "Flux de POC, kg/year/km2",
    sec.axis = sec_axis(~./n, name = "Débit moyen annuel, m3/s"))+
  labs(title = "FPOC, from powerlaw", 
       x = paste("Mean interannual flux =", round(mean_interannual_fpoc/5570,0)), 
       y = "Flux de POC, kg/year/km2")+
  theme_minimal()
```

```{r View-fits}
poc_fits <- rbind(mutate(yearly_fluxes_fitted1, "method" = "tail"), 
                  mutate(select(yearly_fluxes_fitted2, c(year,fpoc_kg.year,mean_annual_q)), "method" = "powerlaw"))

n <- 30

ggplot(poc_fits, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570, fill = method), position = "dodge")+
  geom_point(aes(y = mean_annual_q*n))+
  scale_y_continuous(
    name = "Flux de POC, kg/year/km2",
    sec.axis = sec_axis(~./n, name = "Débit moyen annuel, m3/s"))+
  scale_fill_manual(values = c("palegreen4","lightblue"))+
  labs(y = "Flux de POC, kg/year/km2")+
  theme_minimal()+
  theme(legend.position = "bottom")

```


# FPOC annuel et interannuel avec incertitude (Monte Carlo)

```{r uncertainty-annual-flux, eval = F}
q_u <- 0.1 # from Cedric

poc_isere$cmes_mg.L <- poc_isere$cmes_g.L * 1000
fit_cmes <- lm(mes_mg.L~cmes_mg.L, data = poc_isere)
summary(fit_cmes)

mes_u <- summary(fit_cmes)$coefficients[4]
a_u <- summary(pocfit)$coefficients[3]
b_u <- summary(pocfit)$coefficients[4]
#poc_u <- summary(pocfit)$coefficients[2]

coef_pocfit <- coef(pocfit)

isere$fpoc_mc_mean <- NA
isere$fpoc_mc_sd <- NA

#isere_mc <- isere[]

isere$year <- as.factor(isere$year)
list_isere <-  isere %>% group_split(year)
list_isere <- lapply(list_isere, as.data.frame)
list_isere_mc <- list()

set.seed(0202)

for(j in 1:length(list_isere)){
  
  df <- list_isere[[j]]
  df_mc <- list()

for(i in 1:dim(df)[1]){
  
  DateHeure <- df$DateHeure[i]
  period <- df$period[i]
   
  qn <- rnorm(n = 1000, mean = df$q_m3.s[i], sd = q_u)
  mesn <- rnorm(n = 1000, mean = df$mes_for_fit[i], sd = mes_u)
  an <- rnorm(n = 1000, mean = coef_pocfit[1], sd = a_u) 
  bn <- rnorm(n = 1000, mean = coef_pocfit[2], sd = b_u)
  pocn <- an * mesn^bn + tail_value

  fpocn <- qn * 1e3 * (mesn * pocn * 1e-2) * 1e-6 * period # discharge converted from m3/s to L/h; fPOC is obtained in kg

  fpoc_mean <- fpocn %>% mean()
  fpoc_sd <- fpocn %>% sd()

  list_isere[[j]]$fpoc_mc_mean[i] <- fpoc_mean
  list_isere[[j]]$fpoc_mc_sd[i] <- fpoc_sd
  
  df_mc[[i]] <- data.frame(DateHeure = as.Date(DateHeure), q = qn, mes = mesn, poc = pocn, period = period)
}
list_isere_mc[[j]] <- rbind(df_mc)
}


```

*list_isere_mc* contient 19 éléments: 1 par année de mesure. 
Chaque élément est une matrice. Chaque ligne correspond à une mesure/date. Les colonnes sont les n itérations de Monte Carlo correspondant à cette mesure. Elles sont calculées en tirant aléatoirement une valeur de q (débit), mes, a et b (les coefficients de la loi puissance ).

Dans fpoc_annuel_mc, on calcule le flux annuel correspondant à l'itération n du tirage précédent. On obtient ainsi n valeurs de flux annuel. A partir de ces n valeurs, on calcule le flux de carbone moyen et son intervalle de confiance PAR ANNEE. Ces flux moyens sont stockés dans *fpoc_annuel_mc*. C'est une liste de 19 vecteurs, contenant chacun n flux annuels moyens correspondant à chacune des années de mesure. On en retire le flux moyen annuel *fpoc_annuel_moyen*, la déviation standard *fpoc_annuel_sd* et l'intervalle de confiance *fpoc_annuel_ic* en prenant la moyenne, sd et quantiles de *fpoc_annuel_mc*.

On cherche ensuite à obtenir le flux annuel moyen INTERRANNUEL et son invervalle de confiance. On rassemble les 19 vecteurs de  *fpoc_annuel_mc* dans *fpoc_annuel_mat*. Le résultat est une matrice à 19 lignes et n colonnes. On calcule alors n flux annuels moyens stochés dans *fpoc_interannuel_mc* en faisant une moyenne par colonne. On en retire le flux interannuel moyen *fpoc_interannuel_moyen*, la déviation standard *fpoc_interannuel_sd* et l'intervalle de confiance *fpoc_interannuel_ic* en prenant la moyenne, sd et quantiles de *fpoc_interannuel_mc*.


```{r uncertainty-opti-chatgpt}
N_MC <- 1000
set.seed(202)

q_u <- 0.1 # from Cedric

poc_isere$cmes_mg.L <- poc_isere$cmes_g.L * 1000
fit_cmes <- lm(mes_mg.L~cmes_mg.L, data = poc_isere)
summary(fit_cmes)

mes_u <- summary(fit_cmes)$coefficients[4]
a_u <- summary(pocfit)$coefficients[3]
b_u <- summary(pocfit)$coefficients[4]

coef_poc <- coef(pocfit)
a_mean <- coef_poc[1]
b_mean <- coef_poc[2]

isere$year <- as.factor(isere$year)
list_isere <-  isere %>% group_split(year)
list_isere <- lapply(list_isere, as.data.frame)
list_isere_mc <- list()

list_isere_mc <- vector("list", length(list_isere))

for (j in seq_along(list_isere)) {

  df <- list_isere[[j]]
  n  <- nrow(df)

    # matrice [temps x MC]
  fpoc_mc <- matrix(NA_real_, nrow = n, ncol = N_MC)

  for (i in seq_len(n)) {

    qn   <- rnorm(N_MC, df$q_m3.s[i], q_u)
    mesn <- rnorm(N_MC, df$mes_for_fit[i], mes_u)
    an   <- rnorm(N_MC, a_mean, a_u)
    bn   <- rnorm(N_MC, b_mean, b_u)

    pocn <- an * mesn^bn + tail_value

    fpoc_mc[i, ] <-
      qn * 1e3 *
      (mesn * pocn * 1e-2) *
      1e-6 *
      df$period[i]
  }

  list_isere_mc[[j]] <- fpoc_mc

  # stats instantanées 
  list_isere[[j]]$fpoc_mc_mean <- rowMeans(fpoc_mc)
  list_isere[[j]]$fpoc_mc_sd   <- apply(fpoc_mc, 1, sd)
}
```

```{r uncertainty-annual-interannual}
# Calcul des flux annuels avec incertitude - test année 1. On calcule 1000 flux annuels dont on prend la moyenne puis la sd
fpoc_mc <- list_isere_mc[[1]]
fpoc_annual_mc <- colSums(fpoc_mc, na.rm = TRUE)
mean(fpoc_annual_mc)
sd(fpoc_annual_mc)

quantile(fpoc_annual_mc, c(0.05, 0.5, 0.95))

# check 
sum(fpoc_mc, na.rm = T) / 1000

# moyenne interannuelle: pour chaque élément de la liste isère, on calcule la somme des colonnes 
fpoc_annuel_mc <- lapply(list_isere_mc, function(mat) {
  colSums(mat, na.rm = TRUE)
})

# matrice [année x MC]
fpoc_annuel_mat <- do.call(rbind, fpoc_annuel_mc)

# flux moyens annuels et intervalle de confiance
fpoc_annuel_mean <- rowMeans(fpoc_annuel_mat)

fpoc_annuel_sd  <- apply(fpoc_annuel_mat, 1,sd)

fpoc_annuel_quantile  <- apply(fpoc_annuel_mat, 1, quantile, c(0.05, 0.5, 0.95))

fpoc_annuel <- data.frame(year = unique(isere$year), 
                          mean = fpoc_annuel_mean, 
                          sd = fpoc_annuel_sd, 
                          percent5 = fpoc_annuel_quantile[1,], 
                          percent50 = fpoc_annuel_quantile[2,],
                          percent95 = fpoc_annuel_quantile[3,])


# moyenne pluriannuelle par MC
fpoc_interannuel_mc <- colMeans(fpoc_annuel_mat)

fpoc_interannuel_moyen <- mean(fpoc_interannuel_mc)
fpoc_interannuel_sd    <- sd(fpoc_interannuel_mc)

fpoc_interannuel_ic <- quantile(fpoc_interannuel_mc, c(0.05, 0.5, 0.95))

all_fpoc <- rbind(fpoc_annuel, data.frame(year = "interannual", mean = fpoc_interannuel_moyen, sd = fpoc_interannuel_sd, percent5 = fpoc_interannuel_ic[1], percent50 = fpoc_interannuel_ic[2], percent95 = fpoc_interannuel_ic[3]))


all_fpoc %>% knitr::kable() %>% kableExtra::kable_styling()

# variabilité interannuelle (signal)
var_inter <- var(rowMeans(fpoc_annuel_mat))

# incertitude (bruit)
var_uncert <- mean(apply(fpoc_annuel_mat, 1, var))

ggplot(fpoc_annuel) + 
  geom_col(aes(x = year, y = mean/5570), fill = "palegreen4")+
  geom_errorbar(aes(x = year, ymin = percent5/5570, ymax = percent95/5570), width = 0.2)+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  geom_abline(intercept = fpoc_interannuel_moyen/5570, slope = 0, col = "lightblue")+
  geom_rect(aes(xmin = min(as.numeric(fpoc_annuel$year)-0.5), 
                xmax = max(as.numeric(fpoc_annuel$year)+0.5), 
                ymin = fpoc_interannuel_ic[1]/5570, 
                ymax = fpoc_interannuel_ic[3]/5570), 
            fill = "darkred", alpha = 0.5)+
  theme_minimal()

```

# Estimation of annual POC fluxes, time steps, without uncertainty

```{r time-steps}
isere$day <- isere$DateHeure %>% format("%Y-%m-%d")
isere$week <- week(isere$DateHeure)
isere$month <- month(isere$DateHeure)
```


## Daily means

```{r dayly-flux-poc-fitted, eval = T}
isere_day <- isere %>% group_by(day) %>% summarise(q_m3.s = mean(q_m3.s, na.rm = T), mes_for_fit = mean(mes_for_fit, na.rm = T), mes_for_fit_sd = sd(mes_for_fit, na.rm = T), poc_fitted = mean(poc_fitted, na.rm = T), year = first(year))


isere_day$fpoc_kg.d <- with(isere_day, q_m3.s * 1e3 * (mes_for_fit * poc_fitted * 1e-2) * 1e-6) # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s

day_fluxes_fitted <- isere_day %>% 
                  group_by(year) %>% 
                    summarise(fpoc_kg.year = sum(fpoc_kg.d * 24*60*60, na.rm = T),
                              mean_annual_q = mean(q_m3.s, na.rm = T),
                              nb_datapoints = sum(!is.na(poc_fitted)))

knitr::kable(day_fluxes_fitted)

n <- 30

ggplot(day_fluxes_fitted, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570), fill = "palegreen4")+
  geom_line(aes(y = mean_annual_q*n))+
  scale_y_continuous(
    name = "Flux de POC, kg/year/km2",
    sec.axis = sec_axis(~./n, name = "Débit moyen annuel, m3/s"))+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()
```

```{r daily-mean-with-uncertainty}
N_MC <- 1000
set.seed(202)

q_u <- 0.1 # from Cedric

poc_isere$cmes_mg.L <- poc_isere$cmes_g.L * 1000
fit_cmes <- lm(mes_mg.L~cmes_mg.L, data = poc_isere)
summary(fit_cmes)

mes_u <- summary(fit_cmes)$coefficients[4]
a_u <- summary(pocfit)$coefficients[3]
b_u <- summary(pocfit)$coefficients[4]

coef_poc <- coef(pocfit)
a_mean <- coef_poc[1]
b_mean <- coef_poc[2]

isere$year <- as.factor(isere$year)
list_isere <-  isere %>% group_split(year)
list_isere <- lapply(list_isere, as.data.frame)
list_isere_mc <- list()

list_isere_mc <- vector("list", length(list_isere))

for (j in seq_along(list_isere)) {

  df <- list_isere[[j]]
  n  <- nrow(df)

    # matrice [temps x MC]
  fpoc_mc <- matrix(NA_real_, nrow = n, ncol = N_MC)

  for (i in seq_len(n)) {

    qn   <- rnorm(N_MC, df$q_m3.s[i], q_u)
    mesn <- rnorm(N_MC, df$mes_for_fit[i], mes_u)
    an   <- rnorm(N_MC, a_mean, a_u)
    bn   <- rnorm(N_MC, b_mean, b_u)

    pocn <- an * mesn^bn + tail_value

    fpoc_mc[i, ] <-
      qn * 1e3 *
      (mesn * pocn * 1e-2) *
      1e-6 *
      df$period[i]
  }

  list_isere_mc[[j]] <- fpoc_mc

  # stats instantanées 
  list_isere[[j]]$fpoc_mc_mean <- rowMeans(fpoc_mc)
  list_isere[[j]]$fpoc_mc_sd   <- apply(fpoc_mc, 1, sd)
}
```


## Weekly means

```{r weekly-flux-poc-fitted, eval = T}
isere_week <- isere %>% group_by(week,year) %>% summarise(q_m3.s = mean(q_m3.s, na.rm = T), mes_for_fit = mean(mes_for_fit, na.rm = T), poc_fitted = mean(poc_fitted, na.rm = T))


isere_week$fpoc_kg.d <- with(isere_week, q_m3.s * 1e3 * (mes_for_fit * poc_fitted * 1e-2) * 1e-6) # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s

week_fluxes_fitted <- isere_week %>% 
                  group_by(year) %>% 
                    summarise(fpoc_kg.year = sum(fpoc_kg.d * 7*24*60*60, na.rm = T),
                              mean_annual_q = mean(q_m3.s, na.rm = T),
                              nb_datapoints = sum(!is.na(poc_fitted)))

knitr::kable(week_fluxes_fitted)

n <- 30

ggplot(week_fluxes_fitted, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570), fill = "palegreen4")+
  geom_line(aes(y = mean_annual_q*n))+
  scale_y_continuous(
    name = "Flux de POC, kg/year/km2",
    sec.axis = sec_axis(~./n, name = "Débit moyen annuel, m3/s"))+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()

```

## Monthly means

```{r monthly-flux-poc-fitted, eval = T}
isere_month <- isere %>% group_by(month,year) %>% summarise(q_m3.s = mean(q_m3.s, na.rm = T), mes_for_fit = mean(mes_for_fit, na.rm = T), poc_fitted = mean(poc_fitted, na.rm = T))


isere_month$fpoc_kg.d <- with(isere_month, q_m3.s * 1e3 * (mes_for_fit * poc_fitted * 1e-2) * 1e-6) # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s

month_fluxes_fitted <- isere_month %>% 
                  group_by(year) %>% 
                    summarise(fpoc_kg.year = sum(fpoc_kg.d * 30*24*60*60, na.rm = T),
                              mean_annual_q = mean(q_m3.s, na.rm = T),
                              nb_datapoints = sum(!is.na(poc_fitted)))

knitr::kable(month_fluxes_fitted)

n <- 30

ggplot(month_fluxes_fitted, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570), fill = "palegreen4")+
  geom_line(aes(y = mean_annual_q*n))+
  scale_y_continuous(
    name = "Flux de POC, kg/year/km2",
    sec.axis = sec_axis(~./n, name = "Débit moyen annuel, m3/s"))+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()

```

## Compare time steps

```{r compare-time-steps}

yearly_fluxes <- merge(yearly_fluxes_fitted, day_fluxes_fitted, by = "year", suffixes = c("_hourly", "_daily")) %>%
                  merge(week_fluxes_fitted, by = "year") %>%
                    merge(month_fluxes_fitted, by = "year", suffixes = c("_weekly", "_monthly"))
yearly_fluxes$diff_ref_month <- with(yearly_fluxes, (fpoc_kg.year_monthly - fpoc_kg.year_hourly)/fpoc_kg.year_hourly*100)
yearly_fluxes$diff_ref_week <- with(yearly_fluxes, (fpoc_kg.year_weekly - fpoc_kg.year_hourly)/fpoc_kg.year_hourly*100)
yearly_fluxes$diff_ref_day <- with(yearly_fluxes, (fpoc_kg.year_daily - fpoc_kg.year_hourly)/fpoc_kg.year_hourly*100)

knitr::kable(yearly_fluxes)

yearly_fluxes_long <- rbind(mutate(yearly_fluxes_fitted, freq = "1.hourly"), 
                            mutate(day_fluxes_fitted, freq = "2.daily"),
                            mutate(week_fluxes_fitted, freq = "3.weekly"),
                            mutate(month_fluxes_fitted, freq = "4.monthly"))


ggplot(yearly_fluxes_long, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570, fill = freq), stat = "identity", position = "dodge")+  
  scale_fill_manual(values = c("1.hourly" = "darkblue", "2.daily" = "lightblue", "3.weekly" = "palegreen4", "4.monthly" = "honeydew3"))+
  scale_y_continuous(name = "Flux de POC, kg/year/km2")+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()+
  theme(legend.position = "bottom")

ggplot(yearly_fluxes, aes(x = year))+
  geom_line(aes(y = diff_ref_month, col = "4.monthly"), size = 2)+
    geom_line(aes(y = diff_ref_week, col = "3.weekly"), size = 2)+ 
    geom_line(aes(y = diff_ref_day, col = "2.daily"), size = 2)+ 
  scale_color_manual(values = c("1.hourly" = "darkblue", "2.daily" = "lightblue", "3.weekly" = "palegreen4", "4.monthly" = "honeydew3"))+
  scale_y_continuous(name = "Différence avec le flux de référence, %")+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  scale_x_continuous(breaks = c(unique(yearly_fluxes$year)), minor_breaks = NULL)+
  theme_minimal()+
  theme(legend.position = "bottom")

yearly_fluxes_long %>% group_by(freq) %>% summarise(mean_flux = mean(fpoc_kg.year/5570), sd_flux = sd(fpoc_kg.year/5570), mean_diff_ref = mean((fpoc_kg.year - yearly_fluxes_fitted$fpoc_kg.year)/yearly_fluxes_fitted$fpoc_kg.year*100, na.rm = T)) %>% knitr::kable()


```


```{r exit}
knitr::knit_exit()
```



# Archives

```{r yearly-fluxes, eval = F}
crues$year <- year(crues$Date) %>% as.character()

crues$poc_mg.L <- with(crues, MES_mg.L*COP_percent) # CMES converted from mg/L to kg/L, POC obtained in g is converted to mg
crues$fpoc_kg.h <- with(crues, debit_m3.s * 1e3 * poc_mg.L * 3600 * 1e-6) # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s and converted to kg/h

yearly_fluxes <- crues %>% 
                  group_by(year) %>% 
                    summarise(fpoc_kg.year = sum(fpoc_kg.h*period, na.rm = T), 
                              percent_poc_included = sum(!is.na(fpoc_kg.h))/n()*100,
                              nb_days_sampled = length(unique(Date)),
                              nb_days_sampled_poc = length(unique(Date[!is.na(fpoc_kg.h)])),
                              sum_discharge.year = sum(debit_m3.s, na.rm = T),  # faut-il inclure les débits correspondants à des heures où le POC n'est pas mesuré?
                              mean_discharge.year = mean(debit_m3.s, na.rm = T), 
                              sd_discharge.year = sd(debit_m3.s, na.rm = T),
                              sum_discharge_poc = sum(debit_m3.s[!is.na(fpoc_kg.h)], na.rm = T),
                              mean_discharge_poc = mean(debit_m3.s[!is.na(fpoc_kg.h)], na.rm = T),
                              average_fpoc = mean(fpoc_kg.h, na.rm = T)) 
# discharge is converted from m3/s to L/h before being summed, as in the formula for fpoc

bv <- 5570
  
# fluxes by adding all hourly fluxes, with uncertainty depending on the nb of observations per year
yearly_fluxes$fpoc_kg.year.km2 <- yearly_fluxes$fpoc_kg.year/bv

# fluxes with ponderation method @Nemery2013 citing Walling and Webb 1985
yearly_fluxes$fpoc_ww_kg.year.km2 <- with(yearly_fluxes, fpoc_kg.year/sum_discharge.year*mean_discharge.year) * 24 * 365 / bv

yearly_fluxes$fpoc_wwpoc_kg.year.km2 <- with(yearly_fluxes, fpoc_kg.year/sum_discharge_poc*mean_discharge_poc) * 24 * 365 / bv

# fluxes only average
yearly_fluxes$fpoc_average_kg.y.km2 <- yearly_fluxes$average_fpoc *24*365 / bv

```

```{r figures-flux, eval = F} 
yearly_fluxes %>% dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% knitr::kable() %>% kableExtra::kable_styling()
```

```{r test-2006, eval = F}
t2006 <- crues %>% subset(year == 2006)
t2006

sum(t2006$fpoc_kg.h)
```


```{r compare-fluxes, eval = F}
yearly_fluxes$label <- paste(round(yearly_fluxes$nb_days_sampled,2), "days q\n", round(yearly_fluxes$nb_days_sampled_poc,2), " days poc")
ggplot(yearly_fluxes, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year.km2, fill = "POC flux as sum"), position = position_nudge(-0.2), width = 0.4)+
  geom_col(aes(y = fpoc_ww_kg.year.km2, fill = "POC flux as weigthed"), position = position_nudge(0.2), width = 0.4)+
  geom_label(aes(x = year, y = fpoc_ww_kg.year.km2, label = label), nudge_y = 500, label.size = 0.1)+
  #scale_x_continuous(breaks = c(unique(yearly_fluxes$year)), minor_breaks = NULL)+
  scale_size_continuous(range = c(0.1,10))+
  scale_fill_manual(values = c("palegreen4", "lightblue"))+
  labs(x = "", fill = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()+
  theme(legend.position = "bottom")

ggplot(yearly_fluxes, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year.km2, fill = "POC flux as sum"), position = position_nudge(-0.2), width = 0.4)+
  #scale_x_continuous(breaks = c(unique(yearly_fluxes$year)), minor_breaks = NULL)+
  scale_size_continuous(range = c(0.1,10))+
  scale_fill_manual(values = c("palegreen4", "lightblue"))+
  labs(x = "", fill = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()+
  theme(legend.position = "bottom")
```
```{r yf, eval = F}
yf <- yearly_fluxes %>% subset(nb_days_sampled_poc > 10)

yf %>% dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% knitr::kable() %>% kableExtra::kable_styling()
```

```{r compare-fluxes-nona, eval = F}
yf$label <- paste(round(yf$nb_days_sampled,2), "days q\n", round(yf$nb_days_sampled_poc,2), " days poc")
ggplot(yf, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year.km2, fill = "POC flux as sum"), position = position_nudge(-0.2), width = 0.4)+
  geom_col(aes(y = fpoc_ww_kg.year.km2, fill = "POC flux as weigthed"), position = position_nudge(0.2), width = 0.4)+
  geom_label(aes(x = year, y = fpoc_ww_kg.year.km2, label = label), nudge_y = 15000, size = 3)+
 # scale_x_continuous(breaks = c(unique(yearly_fluxes$year)), minor_breaks = NULL)+
  scale_size_continuous(range = c(0.1,10))+
  scale_fill_manual(values = c("palegreen4", "lightblue"))+
  labs(x = "", fill = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()+
  theme(legend.position = "bottom", text = element_text(size = 10))
```

```{r interrannual-fluxes, eval = F}

mixedfluxes_mean <- with(yf, ifelse(nb_days_sampled_poc < 200, fpoc_ww_kg.year.km2, fpoc_kg.year.km2)) %>% mean()
mixedfluxes_sd <- with(yf, ifelse(nb_days_sampled_poc < 200, fpoc_ww_kg.year.km2, fpoc_kg.year.km2)) %>% sd()

means <- data.frame(
  "Mean FPOC sum, kg/year/m2" = mean(yf$fpoc_kg.year.km2),
  "Sd FPOC sum" = sd(yf$fpoc_kg.year.km2),
  "Mean FPOC weighted, kg/m2/year" = mean(yf$fpoc_ww_kg.year.km2, na.rm = T),
  "Sd FPOC weighted" = sd(yf$fpoc_ww_kg.year.km2, na.rm = T),
  "Mean FPOC mixed" = mixedfluxes_mean,
  "Sd FPOC mixed" = mixedfluxes_sd
)

knitr::kable(t(means), digits = 3) %>% kableExtra::kable_styling()
```


