---
title: "isere"
output: 
  html_document:
    code_folding: hide
date: "2025-06-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, error = F, fig.align = "center", collapse = T,
                      cache = T)
```

```{r libraries}

library(ggplot2)
library(ggpubr)

library(dplyr)
library(readxl)
library(lubridate)

library(bayesbio)
```


# Isère Campus

Les données dont on dispose pour la station de mesures d'Isère - campus sont: 

* débits horaires de 2005 à 2025
* CMES de 2006 à 2025
* POC mesuré (et non calculé): 
    - Carbonisère: suivi hebdo de 2006 à 2008 + crue du 19 mai 2006  + chasse du 27/06/2006 + crue du 30/08/2006 + chasse du 5/06/2006
    - crues du 19/08/2022 (lave torrentielle) et chasse du 22/06/2022
    - suivi hebdo Carbonium (pas encore disponible)
* DOC: 
  - Carbonisère: suivi hebdo de 2006 à 2008 + crue du 19 mai 2006  + chasse du 27/06/2006 + crue du 30/08/2006 + chasse du 5/06/2006
  - suivi hebdo Carbonium (pas encore dispo)



```{r data}

# Crues
carbonisere <- read_xlsx("Bilan carbonisère.xlsx")


crues_2022 <- read_xlsx(path = "Crues_Isère_2022.xlsx", sheet = "test_match") 
crues_2022$mes_mg.L <- NA
crues_2022$debit_m3.s <- NA
crues_2022$doc_mg.L <- NA

doc_isere_2011 <- read_excel("doc_isere_2011-2012.xls")
doc_isere_2011$name <- "DOC 2011"
doc_isere_2011$poc_percent <- NA
doc_isere_2011$mes_mg.L <- doc_isere_2011$mes_g.L * 1e3

poc_isere_2011 <- read_excel("poc_isere_2011-2012.xls")
poc_isere_2011$doc_mg.L <- NA
poc_isere_2011$name <- "POC 2011"
poc_isere_2011$mes_mg.L <- poc_isere_2011$mes_g.L * 1e3

crues <- rbind(select(carbonisere, c("DateHeure","name","debit_m3.s","mes_mg.L","poc_percent", "doc_mg.L")),select(crues_2022, c("DateHeure","name","debit_m3.s", "mes_mg.L","poc_percent", "doc_mg.L"))) %>%
  rbind(select(doc_isere_2011, c("DateHeure","name","debit_m3.s","mes_mg.L","poc_percent", "doc_mg.L"))) %>% rbind(select(poc_isere_2011, c("DateHeure","name","debit_m3.s","mes_mg.L","poc_percent", "doc_mg.L")))

# Chroniques BDOH
cmes <- readxl::read_xlsx(path = "isere.xlsx", sheet = "cmes", col_types = c("date","numeric","text")) %>% subset(Qualite == "v") %>% mutate(Qualite = NULL)
debit <- readxl::read_xlsx(path = "isere.xlsx", sheet = "debit", col_types = c("date","numeric","text")) %>% subset(Qualite == "v") %>% mutate(Qualite = NULL)

  
#crues <- crues %>% group_by(Crue) %>% mutate(period = as.numeric(-(Date - lead(Date)))) # period in hours


isere <- merge(debit, cmes, by="DateHeure") %>% merge(crues, by = "DateHeure", all = T) 
isere$year <- year(isere$DateHeure)
isere$commondate <- as.Date(paste0("2000-", format(isere$Date,"%j")), "%Y-%j")

isere$period <- as.numeric(-(isere$DateHeure - lead(isere$DateHeure))) # period in s

isere %>% subset(!is.na(poc_percent)) %>% group_by(year) %>% summarise(nb_poc = n()) %>% knitr::kable()
isere %>% subset(!is.na(cmes_g.L) & !is.na(q_m3.s)) %>% group_by(year) %>% summarise(nb_cmes = n()) %>% knitr::kable()

```

```{r annual-doc-poc, fig.dim = c(10, 10)}

ggarrange(
ggplot(isere, aes(x = commondate)) + 
  geom_point(aes(y = q_m3.s), col = "lightblue", size = 0.5) +
  scale_x_date(labels = function(x) format(x, "%d-%b"), date_minor_breaks = "1 month", name = "")+
  facet_grid(rows = vars(year))+
  labs(x = "", y = "Q, m3/s") +
  theme_minimal()+
  theme(legend.position = "bottom"),

ggplot(isere, aes(x = commondate)) + 
  geom_point(aes(y = cmes_g.L), col = "palegreen4", size = 0.5) +
  scale_x_date(labels = function(x) format(x, "%d-%b"), date_minor_breaks = "1 month", name = "")+
  facet_grid(rows = vars(year))+
  labs(x = "", y = "CMES, g/L") +
  theme_minimal()+
  theme(legend.position = "bottom"),

ncol = 2
)

```

```{r annual, fig.dim = c(10, 5)}

ggarrange(

ggplot(subset(isere, !is.na(doc_mg.L)), aes(x = commondate)) + 
  geom_point(aes(y = doc_mg.L), col = "orange") +
  scale_x_date(labels = function(x) format(x, "%d-%b"), date_minor_breaks = "1 month", name = "")+
  facet_grid(rows = vars(year))+
  labs(x = "", y = "DOC, mg/L") +
  theme_minimal()+
  theme(legend.position = "bottom"),

ggplot(subset(isere, !is.na(poc_percent)), aes(x = commondate)) + 
  geom_point(aes(y = poc_percent), col = "darkred") +
  scale_x_date(labels = function(x) format(x, "%d-%b"), date_minor_breaks = "1 month", name = "")+
  facet_grid(rows = vars(year))+
  labs(x = "", y = "POC, %") +
  theme_minimal()+
  theme(legend.position = "bottom"),

ncol = 2
)



```

```{r compare-cmes-and-mes}
ggplot(isere)+
  geom_point(aes(x=cmes_g.L, y = mes_mg.L, col = name))+
  geom_abline(slope = 1000, intercept = 0)+
  scale_colour_viridis_d()+
  theme_minimal()

ggarrange(
  ggplot(isere)+
    geom_point(aes(x = mes_mg.L, y = poc_percent, col = name))+
    scale_color_viridis_d()+
    scale_x_continuous(trans = "log")+scale_y_continuous(trans = "log")+
    theme_minimal(),
  ggplot(isere)+
    geom_point(aes(x = cmes_g.L, y = poc_percent, col = name))+
        scale_color_viridis_d()+
      scale_x_continuous(trans = "log")+scale_y_continuous(trans = "log")+
    theme_minimal(),
  ncol = 2, common.legend = T, legend = "bottom"
)


```


## Example of data - Carbonisere

```{r view-fluxes}

ggplot(carbonisere)+
  geom_point(aes(x=as.Date(DateHeure), y = debit_m3.s), col = "cadetblue4")+
  geom_abline(slope = 0, intercept = mean(carbonisere$debit_m3.s, na.rm = T), col = "darkred")+
 annotate(geom = "label", label = round(mean(carbonisere$debit_m3.s, na.rm = T), 2), x= as.Date("2008-01-01"), y = 250)+
   scale_x_date(labels = function(x) format(x, "%d-%b-%y"), date_breaks = "1 year", date_minor_breaks = "1 month",name = "", limits = c(as.Date("2006-01-01"), as.Date("2008-03-31")))+ 
  labs(y = "Débit, m3/s")+
  theme_minimal(base_size = 15)

isere678 <- subset(isere, year == c(2006,2007,2008))

ggplot(isere678)+
  geom_point(aes(x=as.Date(DateHeure), y = q_m3.s), col = "cadetblue4", size = 1)+
  geom_abline(slope = 0, intercept = mean(isere678$q_m3.s, na.rm = T), col = "darkred")+
 annotate(geom = "label", label = round(mean(isere678$q_m3.s, na.rm = T), 2), x= as.Date("2006-01-01"), y = 200)+
   scale_x_date(labels = function(x) format(x, "%d-%b-%y"), date_breaks = "1 year", date_minor_breaks = "1 month",name = "", limits = c(as.Date("2006-01-01"), as.Date("2008-03-31")))+ 
  labs(y = "Débit, m3/s")+
  theme_minimal(base_size = 15)

ggplot(carbonisere)+
  geom_point(aes(x=as.Date(DateHeure), y = doc_mg.L), col = "darkolivegreen4")+
  geom_abline(slope = 0, intercept = mean(carbonisere$doc_mg.L, na.rm = T), col = "darkred")+
 annotate(geom = "label", label = round(mean(carbonisere$doc_mg.L, na.rm = T), 2), x= as.Date("2008-01-01"), y = 3)+
   scale_x_date(labels = function(x) format(x, "%d-%b-%y"), date_breaks = "1 year", date_minor_breaks = "1 month",name = "", limits = c(as.Date("2006-01-01"), as.Date("2008-03-31")))+ 
  labs(y = "Carbone Organique Dissous, mg/L")+
  theme_minimal(base_size = 15)


ggplot(carbonisere)+
  geom_point(aes(x=as.Date(DateHeure), y = poc_percent*mes_mg.L), col = "darkolivegreen4")+
 #  geom_abline(slope = 0, intercept = mean(carbonisere$poc_percent * carbonisere$mes_mg.L, na.rm = T), col = "darkred")+
 # annotate(geom = "label", label = round(mean(carbonisere$poc_percent * carbonisere$mes_mg.L, na.rm = T), 2), x= as.Date("2008-01-01"), y = 3)+
   scale_x_date(labels = function(x) format(x, "%d-%b-%y"), date_breaks = "1 year", date_minor_breaks = "1 month",name = "", limits = c(as.Date("2006-01-01"), as.Date("2008-03-31")))+ 
  labs(y = "Carbone Organique Particulaire, mg/L")+
  theme_minimal(base_size = 15)

```




# Method - which relation MES-POC to choose?


## Fit MES-POC

```{r fit-poc-mes-forcing-end-value}
poc_isere <- isere %>% subset(!is.na(poc_percent))

# find asymptotic value
tail_value <- poc_isere[order(poc_isere$cmes_g.L, decreasing = T),] %>% pull(poc_percent) %>% head(dim(poc_isere)[1]/10) %>% median() # 10% of poc_percent corresponding to the max cmes

# add mes for POC 2011
poc_isere$mes_for_fit <- poc_isere$mes_mg.L
poc_isere$mes_for_fit[which(is.na(poc_isere$mes_for_fit))] <- poc_isere$cmes_g.L[which(is.na(poc_isere$mes_for_fit))]*1e3
poc_isere$tail <- tail_value

pocfit <- nls(
  poc_percent ~ a * mes_for_fit^b + tail,
  data = poc_isere,
  start = list(a = 1, b = -0.5)
)

summary(pocfit)
poc_isere$poc_nls_fitted <- predict(pocfit, poc_isere)

formula_pocfit <- paste("NLS : POC =", round(coef(pocfit)[1],2), "* MES (mg/L) ^", round(coef(pocfit)[2],2), "+", round(tail_value,2))

ggplot(poc_isere)+
  geom_point(aes(x=mes_for_fit, y = poc_percent, col = "measured"))+ 
  geom_point(aes(x=mes_for_fit, y = poc_nls_fitted, col = "fitted"))+ 
  geom_abline(slope = 0, intercept = tail_value, col = "darkred")+
  annotate(geom = "label", label = formula_pocfit, x = Inf, y = Inf, hjust = 1.1, vjust = 1.1)+
  scale_color_manual(values = c("darkblue", "lightblue"))+
  labs(x = "MES, mg/L", y = "POC, %")+
  theme_minimal()

plot(resid(pocfit)~fitted(pocfit))

```

## Should we fit with distinct events ?

Is there a difference between fitting a POC-MES relation when it is event-specific or when we use all values?

```{r fit-by-event, eval = F}
name_crues <- subset(poc_isere, !is.na(name) & name != "DOC 2011") %>% pull(name) %>% unique()

for(i in name_crues){
  df <- poc_isere
  dfi <- subset(df, name == i &!is.na(poc_percent))
  
  dfi$tail <- dfi[order(dfi$mes_mg.L, decreasing = T),] %>% pull(poc_percent) %>% head(dim(dfi)[1]/10) %>% median() # 10% of poc_percent corresponding to the max cmes
  
  a_i <- dfi$poc_percent %>% max()
  b_i <- - dfi$tail[1]/2
    
  fiti <-  tryCatch(
    nls(poc_percent ~ a * mes_for_fit^b + tail, data = dfi, start = list(a = a_i, b = b_i)),
    error = function(e) {lm(poc_percent ~ mes_for_fit, data = dfi)}
  )
  
  if(class(fiti)=="nls"){
    coef1 <- coef(fiti)[1]
    coef2 <- coef(fiti)[2]
    formula_fiti <- paste("NLS : POC =", round(coef1,2), "* MES (mg/L) ^", round(coef2,2), "+", round(dfi$tail[1],2))
  } else {
    coef1 <- coef(fiti)[1]
    coef2 <- coef(fiti)[2]
    formula_fiti <- paste("LM : POC =", format(coef2, scientific = T, digits = 2), "* MES (mg/L) +", round(coef1))
 }

  df$poc_percent_fiti <- predict(fiti, newdata = df)
  
 g <- ggplot(subset(df, name ==i), aes(x = mes_for_fit))+
  geom_point(aes(y = poc_percent, col = "measured"))+
  geom_point(aes(y = poc_percent_fiti, col = "fitted only with this event"))+
  geom_point(aes(y = poc_nls_fitted, col = "fitted with all events"))+
  labs(title = i, x = "MES, mg.L", y = "POC, %", col = "")+
  scale_color_manual(values = c("darkblue","hotpink4","lightblue"))+
  geom_abline(slope = 0, intercept = dfi$tail[1], col = "darkred")+
  annotate(geom = "label", label = formula_fiti, x = Inf, y = Inf, hjust = 1.1, vjust = 1.1)+
  theme_minimal()+
  theme(legend.position = "bottom")
  
 print(g)
}

```

```{r leave-one-out-event-to-fit-the-last, eval = T}
name_crues <- subset(poc_isere, !is.na(name) & name != "DOC 2011") %>% pull(name) %>% unique()

for(i in name_crues){
  df <- poc_isere
  dfi <- subset(df, name != i &!is.na(poc_percent))
  
  dfi$tail <- dfi[order(dfi$mes_mg.L, decreasing = T),] %>% pull(poc_percent) %>% head(dim(dfi)[1]/10) %>% median() # 10% of poc_percent corresponding to the max cmes
  
  a_i <- dfi$poc_percent %>% max()
  b_i <- - dfi$tail[1]/2
    
  fiti <-  tryCatch(
    nls(poc_percent ~ a * mes_for_fit^b + tail, data = dfi, start = list(a = a_i, b = b_i)),
    error = function(e) {lm(poc_percent ~ mes_mg.L, data = dfi)}
  )
  
  if(class(fiti)=="nls"){
    coef1 <- coef(fiti)[1]
    coef2 <- coef(fiti)[2]
    formula_fiti <- paste("NLS : POC =", round(coef1,2), "* MES (mg/L) ^", round(coef2,2), "+", round(dfi$tail[1],2))
  } else {
    coef1 <- coef(fiti)[1]
    coef2 <- coef(fiti)[2]
    formula_fiti <- paste("LM : POC =", format(coef2, scientific = T, digits = 2), "* MES (mg/L) +", round(coef1))
 }

  df$poc_percent_fiti <- predict(fiti, newdata = df)
  
 g <- ggplot(subset(df, name == i), aes(x = mes_for_fit))+
  geom_point(aes(y = poc_percent, col = "measured"))+
  geom_point(aes(y = poc_percent_fiti, col = "fitted with all events except this one"))+
  geom_point(aes(y = poc_nls_fitted, col = "fitted with all events"))+
  labs(title = i, x = "MES, mg.L", y = "POC, %", col = "")+
  scale_color_manual(values = c("darkblue","hotpink4","lightblue"))+
  geom_abline(slope = 0, intercept = dfi$tail[1], col = "darkred")+
  annotate(geom = "label", label = formula_fiti, x = Inf, y = Inf, hjust = 1.1, vjust = 1.1)+
  theme_minimal()+
  theme(legend.position = "bottom")
  
 print(g)
}
```


## Extension of POC values to all dataset

```{r all-poc}
isere$mes_for_fit <- isere$cmes_g.L * 1e3 
isere$mes_for_fit <- ifelse(isere$mes_for_fit ==0, NA, isere$mes_for_fit)
isere$poc_fitted <- predict(pocfit, newdata = isere) 

ggplot(isere, aes(x = mes_for_fit))+
  geom_point(aes(y = poc_percent, col = "measured"))+
  geom_point(aes(y = poc_fitted, col = "fitted with all events"))+
  labs(x = "MES, mg.L", y = "POC, %", col = "")+
  scale_color_manual(values = c("darkblue","lightblue"))+
  geom_abline(slope = 0, intercept = tail_value, col = "darkred")+
  annotate(geom = "label", label = formula_pocfit, x = Inf, y = Inf, hjust = 1.1, vjust = 1.1)+
  theme_minimal()+
  theme(legend.position = "bottom")

```
Calculer annual flux with POC fitted with nls and POC calculated from straight line

## Annual flux for POC fitted from asymptot

```{r yearly-flux-poc-fitted, eval = T}
isere$fpoc_kg.s <- with(isere, q_m3.s * 1e3 * (mes_for_fit * tail_value * 1e-2) * 1e-6) # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s

yearly_fluxes_fitted <- isere %>% 
                  group_by(year) %>% 
                    summarise(fpoc_kg.year = sum(fpoc_kg.s * period, na.rm = T),
                              mean_annual_q = mean(q_m3.s, na.rm = T))

knitr::kable(yearly_fluxes_fitted)

n <- 30

ggplot(yearly_fluxes_fitted, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570), fill = "palegreen4")+
  geom_line(aes(y = mean_annual_q*n))+
  scale_y_continuous(
    name = "Flux de POC, kg/year/km2",
    sec.axis = sec_axis(~./n, name = "Débit moyen annuel, m3/s"))+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()
```

## Annual flux for POC fitted with power law - REFERENCE

```{r yearly-flux-poc-fitted, eval = T}
isere$fpoc_kg.s <- with(isere, q_m3.s * 1e3 * (mes_for_fit * poc_fitted * 1e-2) * 1e-6) # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s

yearly_fluxes_fitted <- isere %>% 
                  group_by(year) %>% 
                    summarise(fpoc_kg.year = sum(fpoc_kg.s * period, na.rm = T),
                              mean_annual_q = mean(q_m3.s, na.rm = T),
                              nb_datapoints = sum(!is.na(poc_fitted))
                              )


knitr::kable(yearly_fluxes_fitted)

n <- 30

ggplot(yearly_fluxes_fitted, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570), fill = "palegreen4")+
  geom_line(aes(y = mean_annual_q*n))+
  scale_y_continuous(
    name = "Flux de POC, kg/year/km2",
    sec.axis = sec_axis(~./n, name = "Débit moyen annuel, m3/s"))+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()
```
```{r uncertainty-annual-flux}
q_u <- 0.1 # from Cedric

poc_isere$cmes_mg.L <- poc_isere$cmes_g.L * 1000
fit_cmes <- lm(mes_mg.L~cmes_mg.L, data = poc_isere)
summary(fit_cmes)

mes_u <- summary(fit_cmes)$coefficients[4]
poc_u <- summary(fit_poc)$coefficients[2]


# fonctionne mais lent
# 
# isere$fpoc_mc_mean <- NA
# isere$fpoc_mc_sd <- NA
# 
# for(i in 1:1000){
#   set.seed(i)
#   qn <- rnorm(n = 10000, mean = isere$q_m3.s[i], sd = q_u)
#   mesn <- rnorm(n = 10000, mean = isere$mes_for_fit[i], sd = mes_u)
#   pocn <- rnorm(n = 10000, mean = isere$poc_fitted[i], sd = poc_u)
#   
#   fpocn <- qn * 1e3 * (mesn * pocn * 1e-2) * 1e-6 # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s
#   
#   fpoc_mean <- fpocn %>% mean()
#   fpoc_sd <- fpocn %>% sd()
#   
#   isere$fpoc_mc_mean[i] <- fpoc_mean
#   isere$fpoc_mc_sd[i] <- fpoc_sd
# }


# version fonction

isere <- isere %>% mutate(mc = purrr::pmap(
  list(q_m3.s, mes_for_fit, poc_fitted),
  ~{
    qn <- rnorm(10000, ..1, q_u)
    mesn <- rnorm(10000, ..2, mes_u)
    pocn <- rnorm(10000, ..3, poc_u)
    
    fpocn <- qn * 1e3 * (mesn * pocn * 1e-2) * 1e-6
    
    tibble(fpoc_mean = mean(fpocn),
           fpoc_sd = sd(fpocn))
  }
)) %>% tidyr::unnest(mc)





df <- data.frame(year = unique(isere$year),
                 fpoc_mc_mean = NA,
                 fpoc_mc_sd = NA)


## pb incertitude 

for(i in 1:length(unique(isere$year))){
  y <- unique(isere$year)[i]
  isi <- subset(isere, year == y)
  
  fpocy <- with(isi, rnorm(10000, fpoc_mean, fpoc_sd) * period)
  fpocy_mean <- mean(fpocy, na.rm = T)
  fpocy_sd <- sd(fpocy, na.rm = T)
  
  df[i, "fpoc_mc_mean"] <- fpocy_mean
  df[i, "fpoc_mc_sd"] <- fpocy_sd
  
}

print('Salut Camille, comment va la Modus ? Eclairante ? Lumineuse')
print('hahaha comme la fisica !')

for(i in 1:dim(isere)[1]){

  
  names(isere)[which(names(isere) == i)] <- paste0("fpoc_mc_", sub("fpoc_", "", i))
}

```

# Estimation of annual POC fluxes, time steps

```{r time-steps}
isere$day <- isere$DateHeure %>% format("%Y-%m-%d")
isere$week <- week(isere$DateHeure)
isere$month <- month(isere$DateHeure)
```


## Daily means

```{r yearly-flux-poc-fitted, eval = T}
isere_day <- isere %>% group_by(day) %>% summarise(q_m3.s = mean(q_m3.s, na.rm = T), mes_for_fit = mean(mes_for_fit, na.rm = T), poc_fitted = mean(poc_fitted, na.rm = T), year = first(year))


isere_day$fpoc_kg.d <- with(isere_day, q_m3.s * 1e3 * (mes_for_fit * poc_fitted * 1e-2) * 1e-6) # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s

day_fluxes_fitted <- isere_day %>% 
                  group_by(year) %>% 
                    summarise(fpoc_kg.year = sum(fpoc_kg.d * 24*60*60, na.rm = T),
                              mean_annual_q = mean(q_m3.s, na.rm = T),
                              nb_datapoints = sum(!is.na(poc_fitted)))

knitr::kable(day_fluxes_fitted)

n <- 30

ggplot(day_fluxes_fitted, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570), fill = "palegreen4")+
  geom_line(aes(y = mean_annual_q*n))+
  scale_y_continuous(
    name = "Flux de POC, kg/year/km2",
    sec.axis = sec_axis(~./n, name = "Débit moyen annuel, m3/s"))+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()

```


## Weekly means

```{r yearly-flux-poc-fitted, eval = T}
isere_week <- isere %>% group_by(week,year) %>% summarise(q_m3.s = mean(q_m3.s, na.rm = T), mes_for_fit = mean(mes_for_fit, na.rm = T), poc_fitted = mean(poc_fitted, na.rm = T))


isere_week$fpoc_kg.d <- with(isere_week, q_m3.s * 1e3 * (mes_for_fit * poc_fitted * 1e-2) * 1e-6) # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s

week_fluxes_fitted <- isere_week %>% 
                  group_by(year) %>% 
                    summarise(fpoc_kg.year = sum(fpoc_kg.d * 7*24*60*60, na.rm = T),
                              mean_annual_q = mean(q_m3.s, na.rm = T),
                              nb_datapoints = sum(!is.na(poc_fitted)))

knitr::kable(week_fluxes_fitted)

n <- 30

ggplot(week_fluxes_fitted, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570), fill = "palegreen4")+
  geom_line(aes(y = mean_annual_q*n))+
  scale_y_continuous(
    name = "Flux de POC, kg/year/km2",
    sec.axis = sec_axis(~./n, name = "Débit moyen annuel, m3/s"))+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()

```

## Monthly means

```{r yearly-flux-poc-fitted, eval = T}
isere_month <- isere %>% group_by(month,year) %>% summarise(q_m3.s = mean(q_m3.s, na.rm = T), mes_for_fit = mean(mes_for_fit, na.rm = T), poc_fitted = mean(poc_fitted, na.rm = T))


isere_month$fpoc_kg.d <- with(isere_month, q_m3.s * 1e3 * (mes_for_fit * poc_fitted * 1e-2) * 1e-6) # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s

month_fluxes_fitted <- isere_month %>% 
                  group_by(year) %>% 
                    summarise(fpoc_kg.year = sum(fpoc_kg.d * 30*24*60*60, na.rm = T),
                              mean_annual_q = mean(q_m3.s, na.rm = T),
                              nb_datapoints = sum(!is.na(poc_fitted)))

knitr::kable(month_fluxes_fitted)

n <- 30

ggplot(month_fluxes_fitted, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570), fill = "palegreen4")+
  geom_line(aes(y = mean_annual_q*n))+
  scale_y_continuous(
    name = "Flux de POC, kg/year/km2",
    sec.axis = sec_axis(~./n, name = "Débit moyen annuel, m3/s"))+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()

```

## Compare time steps

```{r compare-time-steps}

yearly_fluxes <- merge(yearly_fluxes_fitted, day_fluxes_fitted, by = "year", suffixes = c("_hourly", "_daily")) %>%
                  merge(week_fluxes_fitted, by = "year") %>%
                    merge(month_fluxes_fitted, by = "year", suffixes = c("_weekly", "_monthly"))
yearly_fluxes$diff_ref_month <- with(yearly_fluxes, (fpoc_kg.year_monthly - fpoc_kg.year_hourly)/fpoc_kg.year_hourly*100)
yearly_fluxes$diff_ref_week <- with(yearly_fluxes, (fpoc_kg.year_weekly - fpoc_kg.year_hourly)/fpoc_kg.year_hourly*100)
yearly_fluxes$diff_ref_day <- with(yearly_fluxes, (fpoc_kg.year_daily - fpoc_kg.year_hourly)/fpoc_kg.year_hourly*100)

knitr::kable(yearly_fluxes)

yearly_fluxes_long <- rbind(mutate(yearly_fluxes_fitted, freq = "1.hourly"), 
                            mutate(day_fluxes_fitted, freq = "2.daily"),
                            mutate(week_fluxes_fitted, freq = "3.weekly"),
                            mutate(month_fluxes_fitted, freq = "4.monthly"))


ggplot(yearly_fluxes_long, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year/5570, fill = freq), stat = "identity", position = "dodge")+  
  scale_fill_manual(values = c("1.hourly" = "darkblue", "2.daily" = "lightblue", "3.weekly" = "palegreen4", "4.monthly" = "honeydew3"))+
  scale_y_continuous(name = "Flux de POC, kg/year/km2")+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  scale_x_continuous(breaks = c(unique(yearly_fluxes$year)), minor_breaks = NULL)+
  theme_minimal()+
  theme(legend.position = "bottom")

ggplot(yearly_fluxes, aes(x = year))+
  geom_line(aes(y = diff_ref_month, col = "4.monthly"), size = 2)+
    geom_line(aes(y = diff_ref_week, col = "3.weekly"), size = 2)+ 
    geom_line(aes(y = diff_ref_day, col = "2.daily"), size = 2)+ 
  scale_color_manual(values = c("1.hourly" = "darkblue", "2.daily" = "lightblue", "3.weekly" = "palegreen4", "4.monthly" = "honeydew3"))+
  scale_y_continuous(name = "Différence avec le flux de référence, %")+
  labs(x = "", y = "Flux de POC, kg/year/km2")+
  scale_x_continuous(breaks = c(unique(yearly_fluxes$year)), minor_breaks = NULL)+
  theme_minimal()+
  theme(legend.position = "bottom")

yearly_fluxes_long %>% group_by(freq) %>% summarise(mean_flux = mean(fpoc_kg.year/5570), sd_flux = sd(fpoc_kg.year/5570), mean_diff_ref = mean((fpoc_kg.year - yearly_fluxes_fitted$fpoc_kg.year)/yearly_fluxes_fitted$fpoc_kg.year*100, na.rm = T)) %>% knitr::kable()


```


```{r exit}
knitr::knit_exit()
```



# Archives

```{r yearly-fluxes, eval = F}
crues$year <- year(crues$Date) %>% as.character()

crues$poc_mg.L <- with(crues, MES_mg.L*COP_percent) # CMES converted from mg/L to kg/L, POC obtained in g is converted to mg
crues$fpoc_kg.h <- with(crues, debit_m3.s * 1e3 * poc_mg.L * 3600 * 1e-6) # discharge converted from m3/s to L/h; fPOC is obtained in mg/L/s and converted to kg/h

yearly_fluxes <- crues %>% 
                  group_by(year) %>% 
                    summarise(fpoc_kg.year = sum(fpoc_kg.h*period, na.rm = T), 
                              percent_poc_included = sum(!is.na(fpoc_kg.h))/n()*100,
                              nb_days_sampled = length(unique(Date)),
                              nb_days_sampled_poc = length(unique(Date[!is.na(fpoc_kg.h)])),
                              sum_discharge.year = sum(debit_m3.s, na.rm = T),  # faut-il inclure les débits correspondants à des heures où le POC n'est pas mesuré?
                              mean_discharge.year = mean(debit_m3.s, na.rm = T), 
                              sd_discharge.year = sd(debit_m3.s, na.rm = T),
                              sum_discharge_poc = sum(debit_m3.s[!is.na(fpoc_kg.h)], na.rm = T),
                              mean_discharge_poc = mean(debit_m3.s[!is.na(fpoc_kg.h)], na.rm = T),
                              average_fpoc = mean(fpoc_kg.h, na.rm = T)) 
# discharge is converted from m3/s to L/h before being summed, as in the formula for fpoc

bv <- 5570
  
# fluxes by adding all hourly fluxes, with uncertainty depending on the nb of observations per year
yearly_fluxes$fpoc_kg.year.km2 <- yearly_fluxes$fpoc_kg.year/bv

# fluxes with ponderation method @Nemery2013 citing Walling and Webb 1985
yearly_fluxes$fpoc_ww_kg.year.km2 <- with(yearly_fluxes, fpoc_kg.year/sum_discharge.year*mean_discharge.year) * 24 * 365 / bv

yearly_fluxes$fpoc_wwpoc_kg.year.km2 <- with(yearly_fluxes, fpoc_kg.year/sum_discharge_poc*mean_discharge_poc) * 24 * 365 / bv

# fluxes only average
yearly_fluxes$fpoc_average_kg.y.km2 <- yearly_fluxes$average_fpoc *24*365 / bv

```

```{r figures-flux, eval = F} 
yearly_fluxes %>% dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% knitr::kable() %>% kableExtra::kable_styling()
```

```{r test-2006, eval = F}
t2006 <- crues %>% subset(year == 2006)
t2006

sum(t2006$fpoc_kg.h)
```


```{r compare-fluxes, eval = F}
yearly_fluxes$label <- paste(round(yearly_fluxes$nb_days_sampled,2), "days q\n", round(yearly_fluxes$nb_days_sampled_poc,2), " days poc")
ggplot(yearly_fluxes, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year.km2, fill = "POC flux as sum"), position = position_nudge(-0.2), width = 0.4)+
  geom_col(aes(y = fpoc_ww_kg.year.km2, fill = "POC flux as weigthed"), position = position_nudge(0.2), width = 0.4)+
  geom_label(aes(x = year, y = fpoc_ww_kg.year.km2, label = label), nudge_y = 500, label.size = 0.1)+
  #scale_x_continuous(breaks = c(unique(yearly_fluxes$year)), minor_breaks = NULL)+
  scale_size_continuous(range = c(0.1,10))+
  scale_fill_manual(values = c("palegreen4", "lightblue"))+
  labs(x = "", fill = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()+
  theme(legend.position = "bottom")

ggplot(yearly_fluxes, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year.km2, fill = "POC flux as sum"), position = position_nudge(-0.2), width = 0.4)+
  #scale_x_continuous(breaks = c(unique(yearly_fluxes$year)), minor_breaks = NULL)+
  scale_size_continuous(range = c(0.1,10))+
  scale_fill_manual(values = c("palegreen4", "lightblue"))+
  labs(x = "", fill = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()+
  theme(legend.position = "bottom")
```
```{r yf, eval = F}
yf <- yearly_fluxes %>% subset(nb_days_sampled_poc > 10)

yf %>% dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% knitr::kable() %>% kableExtra::kable_styling()
```

```{r compare-fluxes-nona, eval = F}
yf$label <- paste(round(yf$nb_days_sampled,2), "days q\n", round(yf$nb_days_sampled_poc,2), " days poc")
ggplot(yf, aes(x = year))+
  geom_col(aes(y = fpoc_kg.year.km2, fill = "POC flux as sum"), position = position_nudge(-0.2), width = 0.4)+
  geom_col(aes(y = fpoc_ww_kg.year.km2, fill = "POC flux as weigthed"), position = position_nudge(0.2), width = 0.4)+
  geom_label(aes(x = year, y = fpoc_ww_kg.year.km2, label = label), nudge_y = 15000, size = 3)+
 # scale_x_continuous(breaks = c(unique(yearly_fluxes$year)), minor_breaks = NULL)+
  scale_size_continuous(range = c(0.1,10))+
  scale_fill_manual(values = c("palegreen4", "lightblue"))+
  labs(x = "", fill = "", y = "Flux de POC, kg/year/km2")+
  theme_minimal()+
  theme(legend.position = "bottom", text = element_text(size = 10))
```

```{r interrannual-fluxes, eval = F}

mixedfluxes_mean <- with(yf, ifelse(nb_days_sampled_poc < 200, fpoc_ww_kg.year.km2, fpoc_kg.year.km2)) %>% mean()
mixedfluxes_sd <- with(yf, ifelse(nb_days_sampled_poc < 200, fpoc_ww_kg.year.km2, fpoc_kg.year.km2)) %>% sd()

means <- data.frame(
  "Mean FPOC sum, kg/year/m2" = mean(yf$fpoc_kg.year.km2),
  "Sd FPOC sum" = sd(yf$fpoc_kg.year.km2),
  "Mean FPOC weighted, kg/m2/year" = mean(yf$fpoc_ww_kg.year.km2, na.rm = T),
  "Sd FPOC weighted" = sd(yf$fpoc_ww_kg.year.km2, na.rm = T),
  "Mean FPOC mixed" = mixedfluxes_mean,
  "Sd FPOC mixed" = mixedfluxes_sd
)

knitr::kable(t(means), digits = 3) %>% kableExtra::kable_styling()
```






See the Isere file is OSR

# Isère - Beaumont

```{r data-beaumont, eval = F}
cmes <- read_xlsx("OSR/isere.xlsx", sheet = "CMES", col_types = c("date","numeric","text")) 
poc <- read_xlsx("OSR/isere.xlsx", sheet = "COP") %>% subset(Qualite = "v") 
debit <- read_xlsx("OSR/isere.xlsx", sheet = "Debit", col_types = c("date", "numeric","text","text","text","text"))

poc$poc_timeinterval <- poc$Debut %--% poc$Fin
```

```{r plot-data, eval = F}
ggpubr::ggarrange(
ggplot(poc)+geom_point(aes(x= Debut, y = COP_g.kg)) + labs(x="Date", y = "POC, g(C)/kg(MES)"),
ggplot(cmes)+geom_line(aes(x= DateHeure, y = cmes_mg.L)) + labs(x="Date", y = "MES, mg/L"),
ggplot(debit)+geom_line(aes(x= DateHeure, y = q_m3.s)) + labs(x="Date", y = "Discharge, m3/s"),
nrow = 3
)
```
```{r missing-dates-debit, eval = F}

dates_debit <- debit %>% tidyr::complete(DateHeure = seq(min(DateHeure), max(DateHeure), by = "1 hour"))
percent_missing <- (dim(dates_debit)[1] - dim(debit)[1])/dim(dates_debit)[1] * 100 

print(paste("Percent missing : ",round(percent_missing, 2), "%"))

```
```{r merge-poc-mes, eval = F}

na_interval <- poc$Fin[86] %--% poc$Debut[1]  %>% as.character()

# poc$poc_timeinterval[debit$DateHeure[100] >= poc$Debut & debit$DateHeure[100] <= poc$Fin]

debit_timeinterval <- sapply(debit$DateHeure, FUN = function (x){as.character(poc$poc_timeinterval[x >= poc$Debut & x <= poc$Fin]), eval = F}, simplify = T)
na_timeinterval <- which(lengths(debit_timeinterval) == 0)
debit_timeinterval[na_timeinterval] <- na_interval

debit$poc_timeinterval <- do.call(c, (debit_timeinterval))

```

```{r join-cmes-poc-debit, eval = F}

isere <- merge(debit, poc, by = "poc_timeinterval", all = T) %>% merge(cmes, by = "DateHeure", all = T)


library(imputeTS)
isere$cmes_interpol <- na_interpolation(isere$cmes_mg.L, maxgap = 24) # impossible to interpol

```

```{r plot-data-2, eval = F}
isere$year <- year(isere$DateHeure)
isere$commondate <- as.Date(paste0("2000-", format(isere$DateHeure,"%j")), "%Y-%j")
isere$commondebut <- as.Date(paste0("2000-", format(isere$Debut,"%j")), "%Y-%j")
isere$commonfin <- as.Date(paste0("2000-", format(isere$Fin,"%j")), "%Y-%j")

for(i in unique(isere$year)){
g <- ggplot(data = filter(isere, year == i))+ 
  geom_point(aes(x=DateHeure, y= cmes_mg.L, col="MES, g/L"), alpha = 0.5, size = 0.5) +
  geom_segment(aes(x=Debut, xend = Fin, y = COP_g.kg*50, yend = COP_g.kg*50), col = "lightblue", size = 1)+
  geom_segment(aes(x=Debut, xend = Debut, y = 0, yend = COP_g.kg*50), col = "lightblue", alpha = 0.5, size = 0.1)+
  geom_segment(aes(x=Fin, xend = Fin, y = 0, yend = COP_g.kg), col = "lightblue", alpha = 0.5, size = 0.1)+
  scale_color_manual(values = "palegreen4")+
  #scale_x_date(labels = function(x) format(x, "%d-%b"), date_minor_breaks = "1 month")+
  scale_y_continuous( name = "MES, mg/L", sec.axis = sec_axis(~./50, name = "POC, g/kg"))+
  labs(title = i, x = "")+
  theme_minimal()+
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))
  
  print(g)
, eval = F}

```


```{r calcul-flux, eval = F} 
isere_complete <- isere %>% subset(!is.na(q_m3.s))
bv <-  11800  # taille du bassin versant en km2, de Justin


isere_complete$fpoc_kg.h <- with(isere_complete, q_m3.s * 1e3 *3600 * cmes_interpol*1e-6 * COP_g.kg * 1e-3 ) # discharge converted from m3/s to L/h; CMES converted from mg/L to kg/L, POC is obtained in g/L/h and converted to kg/L/h

ggplot()+ 
  geom_point(data = subset(isere_complete, !is.na(cmes_mg.L)),aes(x=DateHeure, y= fpoc_kg.h,col="cmes mg/L"), alpha = 0.5, size = 0.5) +
  scale_color_manual(values = "palegreen4")+
  scale_y_continuous(transform = "log10")+
  theme_minimal()+
  theme(legend.position = "bottom")


yearly_fluxes <- isere_complete %>% group_by(year) %>% summarise(fpoc_kg.year = sum(fpoc_kg.h, na.rm = T), percent_of_year_included = sum(!is.na(fpoc_kg.h))/n()*100, sum_discharge_L.year = sum(q_m3.s * 1e3 * 3600), mean_discharge_L.year = mean(q_m3.s * 1e3 * 3600, na.rm = T), sd_discharge_L.year = sd(q_m3.s * 1e3 * 3600, na.rm = T)) 
# discharge is converted from m3/s to L/h before being summed, as in the formula for fpoc

# fluxes by adding all hourly fluxes, with uncertainty depending on the nb of observations per year
yearly_fluxes$fpoc_kg.year.km2 <- yearly_fluxes$fpoc_kg.year/bv

# fluxes with ponderation method @Nemery2013 citing Walling and Webb 1985
yearly_fluxes$fpoc_ww <- with(yearly_fluxes, fpoc_kg.year/sum_discharge_L.year*mean_discharge_L.year) / bv

ggpubr::ggarrange(
ggplot(yearly_fluxes)+
  geom_point(aes(x=mean_discharge_L.year, y = sum_discharge_L.year, size = sd_discharge_L.year)) + 
  geom_text(aes(x=mean_discharge_L.year, y = sum_discharge_L.year , label = year), col = "firebrick"),
ggplot(yearly_fluxes)+
  geom_point(aes(y=fpoc_kg.year, x = sum_discharge_L.year, size = sd_discharge_L.year)) + 
  geom_text(aes(y=fpoc_kg.year, x = sum_discharge_L.year , label = year), col = "firebrick"),
ncol = 2, common.legend = T, legend = "bottom")

yearly_fluxes %>% dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>% knitr::kable()

ggplot(yearly_fluxes)+
  geom_line(aes(x=year, y = fpoc_kg.year.km2, col = "FPOC as sum"))+
  geom_line(aes(x=year, y = fpoc_ww*1e4, col = "FPOC weighted"))+
  scale_y_continuous( name = "FPOC summed, kg/yearKkm2", sec.axis = sec_axis(~.*1e-4, name = "FPOC weighted, kg/year/km2"))+
  scale_color_manual(values = c("palegreen4", "lightblue"))+
  
  theme_minimal()
```
